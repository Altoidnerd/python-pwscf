#!/bin/bash
#
#
# Copyright (c) 2016 altoidnerd                                                 
#################################################################################
#                      								#
# Permission is hereby granted, free of charge, to any person obtaining a 	#
# copy of this software and associated documentation files (the "Software"),	#
# to deal in the Software without restriction, including without limitation 	#
# the rights to use, copy, modify, merge, publish, distribute, sublicense, 	#
# and/or sell copies of the Software, and to permit persons to whom the 	#
# Software is furnished to do so, subject to the following conditions:		#
#										#
# The above copyright notice and this permission notice shall be included 	#
# in all copies or substantial portions of the Software.			#
#										#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 	#
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 	#
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL 	#
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 	#
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,	#
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE	#
# THE SOFTWARE.									#
#################################################################################
#
#
#
# run from directory where this script is
# cd `echo $0 | sed 's/\(.*\)\/.*/\1/'` # extract pathname
#
#


example_dir=`pwd`

# check whether echo has the -e option
e="echo -e"

$e
$e "$example_dir : starting"
$e

$e  
$e "...setting the needed environment variables..."
$e

#. ./environment_variables

$e "done."
$e

# required executables and pseudopotentials
bin_file="pw.x"
pseudo_dir="$HOME/.data/PSEUDOPOTENTIALS"
tmp_dir="./scratch"
bin_dir="$HOME/espresso-5.3.0/bin"
np=168
structure="RDX"
calculation="scf"
relaxed="no"
note="conv_thr,forc_conv_thr are em4,default"

$e
$e "  executables directory: $bin_dir"
$e "  pseudo directory:      $pseudo_dir"
$e "  temporary directory:   $tmp_dir"
$e "  checking that needed directories and files exist..."
$e
$e " OK"
$e

for ecut in 20 40 60 80 100; do
    cat > scf.pbe-n-kjpaw.kp242.ec-$ecut.nofor-nostress.in << EOF
    &CONTROL 
calculation = 'scf'
prefix='scf.pbe-n-kjpaw-ec-$ecut-kp242.nofor.nostress'
pseudo_dir = '$HOME/.data/PSEUDOPOTENTIALS'
outdir='./scratch'
!tstress=.true.
!tprnfor = .true.
forc_conv_thr=1.0d-4
nstep=200
/
    &SYSTEM 
ibrav=0
celldm(1)=1.889726
nat=168
ntyp=4
ecutwfc=$ecut
ecutrho=${ecut}0/ 
    &ELECTRONS
mixing_beta=0.7
conv_thr =  1.0d-4
electron_maxstep=200
/
    &IONS
trust_radius_max=0.2
/
    &CELL
cell_dynamics='bfgs'
/
ATOMIC_SPECIES
  N  14.0067  N.pbe-n-kjpaw_psl.1.0.0.UPF
  C  12.0110  C.pbe-n-kjpaw_psl.1.0.0.UPF
  H   1.0079  H.pbe-kjpaw_psl.1.0.0.UPF
  O  15.9994  O.pbe-n-kjpaw_psl.1.0.0.UPF

CELL_PARAMETERS (alat) 
  15.1267000000    0.0000000000    0.0000000000
   0.0000000000    7.4563000000    0.0000000000
   0.0000000000    0.0000000000   14.3719000000

ATOMIC_POSITIONS (crystal)
 C       0.490400000     0.667600000     0.450400000
 N       0.544100000     0.705700000     0.531500000
 N       0.507300000     0.830300000     0.594200000
 O       0.447600000     0.925700000     0.566500000
 O       0.540000000     0.839500000     0.670300000
 C       0.582100000     0.547100000     0.574200000
 N       0.515800000     0.410800000     0.592700000
 O       0.515600000     0.495300000     0.742500000
 O       0.411100000     0.321400000     0.689700000
 N       0.476200000     0.410700000     0.680600000
 C       0.459800000     0.369300000     0.514100000
 N       0.425600000     0.531100000     0.468900000
 N       0.339900000     0.586300000     0.489600000
 O       0.316280000     0.730500000     0.459900000
 O       0.294500000     0.483800000     0.533100000
 C       0.741500000     0.089600000     0.205900000
 N       0.789580000    -0.035900000     0.264900000
 N       0.870700000     0.020600000     0.302500000
 O       0.905000000     0.152400000     0.267300000
 O       0.901900000    -0.072600000     0.363600000
 C       0.735300000    -0.156300000     0.320600000
 N       0.666000000    -0.060000000     0.369400000
 N       0.680000000    -0.014100000     0.462800000
 O       0.738400000    -0.096600000     0.503200000
 O       0.629810000     0.093700000     0.498300000
 C       0.615800000     0.068000000     0.311800000
 N       0.673200000     0.185200000     0.258000000
 N       0.697000000     0.348600000     0.298200000
 O       0.649600000     0.404300000     0.360300000
 O       0.759100000     0.427700000     0.264500000
 H       0.461500000     0.772900000     0.428000000
 H       0.528800000     0.617500000     0.403500000
 H       0.614600000     0.583300000     0.630000000
 H       0.624500000     0.497700000     0.530300000
 H       0.496200000     0.306300000     0.469900000
 H       0.407700000     0.297700000     0.539000000
 H       0.781400000     0.175900000     0.176600000
 H       0.710300000     0.018600000     0.158600000
 H       0.772700000    -0.218200000     0.365900000
 H       0.706600000    -0.241600000     0.276200000
 H       0.578700000     0.139600000     0.351100000
 H       0.581300000    -0.000400000     0.267700000
 H       0.418700000     1.000400000     0.767700000
 H       0.421300000     0.860400000     0.851100000
 H       0.293400000     1.241600000     0.776200000
 H       0.227300000     1.218200000     0.865900000
 H       0.289700000     0.981400000     0.658600000
 H       0.218600000     0.824100000     0.676600000
 H       0.592300000     0.702300000     0.039000000
 H       0.503800000     0.693700000    -0.030100000
 H       0.375500000     0.502300000     0.030300000
 H       0.385400000     0.416700000     0.130000000
 H       0.471200000     0.382500000    -0.096500000
 H       0.538500000     0.227100000    -0.072000000
 O       0.240900000     0.572300000     0.764500000
 O       0.350400000     0.595700000     0.860300000
 N       0.303000000     0.651400000     0.798200000
 N       0.326800000     0.814800000     0.758000000
 C       0.384200000     0.932000000     0.811800000
 O       0.370190000     0.906300000     0.998300000
 O       0.261600000     1.096600000     1.003200000
 N       0.320000000     1.014100000     0.962800000
 N       0.334000000     1.060000000     0.869400000
 C       0.264700000     1.156300000     0.820600000
 O       0.098100000     1.072600000     0.863600000
 O       0.095000000     0.847600000     0.767300000
 N       0.129300000     0.979400000     0.802500000
 N       0.210420000     1.035900000     0.764900000
 C       0.258500000     0.910400000     0.705900000
 O       0.705500000     0.516200000     0.033100000
 O       0.683720000     0.269500000    -0.040100000
 N       0.660100000     0.413700000    -0.010400000
 N       0.574400000     0.468900000    -0.031100000
 C       0.540200000     0.630700000     0.014100000
 N       0.523800000     0.589300000     0.180600000
 O       0.588900000     0.678600000     0.189700000
 O       0.484400000     0.504700000     0.242500000
 N       0.484200000     0.589200000     0.092700000
 C       0.417900000     0.452900000     0.074200000
 O       0.460000000     0.160500000     0.170300000
 O       0.552400000     0.074300000     0.066500000
 N       0.492700000     0.169700000     0.094200000
 N       0.455900000     0.294300000     0.031500000
 C       0.509600000     0.332400000    -0.049600000
 H       0.081300000     1.000400000     0.267700000
 H       0.078700000     0.860400000     0.351100000
 H       0.206600000     1.241600000     0.276200000
 H       0.272700000     1.218200000     0.365900000
 H       0.210300000     0.981400000     0.158600000
 H       0.281400000     0.824100000     0.176600000
 H       0.907700000     0.702300000     0.539000000
 H       0.996200000     0.693700000     0.469900000
 H       1.124500000     0.502300000     0.530300000
 H       1.114600000     0.416700000     0.630000000
 H       1.028800000     0.382500000     0.403500000
 H       0.961500000     0.227100000     0.428000000
 O       0.259100000     0.572300000     0.264500000
 O       0.149600000     0.595700000     0.360300000
 N       0.197000000     0.651400000     0.298200000
 N       0.173200000     0.814800000     0.258000000
 C       0.115800000     0.932000000     0.311800000
 O       0.129810000     0.906300000     0.498300000
 O       0.238400000     1.096600000     0.503200000
 N       0.180000000     1.014100000     0.462800000
 N       0.166000000     1.060000000     0.369400000
 C       0.235300000     1.156300000     0.320600000
 O       0.401900000     1.072600000     0.363600000
 O       0.405000000     0.847600000     0.267300000
 N       0.370700000     0.979400000     0.302500000
 N       0.289580000     1.035900000     0.264900000
 C       0.241500000     0.910400000     0.205900000
 O       0.794500000     0.516200000     0.533100000
 O       0.816280000     0.269500000     0.459900000
 N       0.839900000     0.413700000     0.489600000
 N       0.925600000     0.468900000     0.468900000
 C       0.959800000     0.630700000     0.514100000
 N       0.976200000     0.589300000     0.680600000
 O       0.911100000     0.678600000     0.689700000
 O       1.015600000     0.504700000     0.742500000
 N       1.015800000     0.589200000     0.592700000
 C       1.082100000     0.452900000     0.574200000
 O       1.040000000     0.160500000     0.670300000
 O       0.947600000     0.074300000     0.566500000
 N       1.007300000     0.169700000     0.594200000
 N       1.044100000     0.294300000     0.531500000
 C       0.990400000     0.332400000     0.450400000
 H       0.918700000    -0.000400000     0.767700000
 H       0.921300000     0.139600000     0.851100000
 H       0.793400000    -0.241600000     0.776200000
 H       0.727300000    -0.218200000     0.865900000
 H       0.789700000     0.018600000     0.658600000
 H       0.718600000     0.175900000     0.676600000
 H       0.092300000     0.297700000     0.039000000
 H       0.003800000     0.306300000    -0.030100000
 H      -0.124500000     0.497700000     0.030300000
 H      -0.114600000     0.583300000     0.130000000
 H      -0.028800000     0.617500000    -0.096500000
 H       0.038500000     0.772900000    -0.072000000
 O       0.740900000     0.427700000     0.764500000
 O       0.850400000     0.404300000     0.860300000
 N       0.803000000     0.348600000     0.798200000
 N       0.826800000     0.185200000     0.758000000
 C       0.884200000     0.068000000     0.811800000
 O       0.870190000     0.093700000     0.998300000
 O       0.761600000    -0.096600000     1.003200000
 N       0.820000000    -0.014100000     0.962800000
 N       0.834000000    -0.060000000     0.869400000
 C       0.764700000    -0.156300000     0.820600000
 O       0.598100000    -0.072600000     0.863600000
 O       0.595000000     0.152400000     0.767300000
 N       0.629300000     0.020600000     0.802500000
 N       0.710420000    -0.035900000     0.764900000
 C       0.758500000     0.089600000     0.705900000
 O       0.205500000     0.483800000     0.033100000
 O       0.183720000     0.730500000    -0.040100000
 N       0.160100000     0.586300000    -0.010400000
 N       0.074400000     0.531100000    -0.031100000
 C       0.040200000     0.369300000     0.014100000
 N       0.023800000     0.410700000     0.180600000
 O       0.088900000     0.321400000     0.189700000
 O      -0.015600000     0.495300000     0.242500000
 N      -0.015800000     0.410800000     0.092700000
 C      -0.082100000     0.547100000     0.074200000
 O      -0.040000000     0.839500000     0.170300000
 O       0.052400000     0.925700000     0.066500000
 N      -0.007300000     0.830300000     0.094200000
 N      -0.044100000     0.705700000     0.031500000
 C       0.009600000     0.667600000    -0.049600000
K_POINTS automatic
 2 4 2 1 1 1 

EOF

    $e " " >> debug.log
    $e "########################SCF LOG ENTRY########################" >> debug.log 
    $e "$0 by $(whoami) running on $HOSTNAME " >> debug.log
    $e "$(date +%b%d-%T-%Y)" >> debug.log
    $e "running: $bin_file" >> debug.log 
    $e "nproc is: \t\t $np cores" >> debug.log
    $e "structure is: \t\t $structure" >> debug.log
    $e "program is: \t\t $bin_file" >> debug.log
    $e "calculation is:\t\t $calculation" >> debug.log
    $e "ecutwfc is:\t\t $ecut Ry" >> debug.log
    $e "relaxed: \t\t no" >> debug.log
    $e "Do note:\t\t $note" >> debug.log
    $e " " >> debug.log    
    

    mpirun -n $np nice -n 19 $bin_file < scf.pbe-n-kjpaw.kp242.ec-$ecut.nofor-nostress.in > scf.pbe-n-kjpaw.kp242.ec-$ecut.nofor-nostress.out  
done

